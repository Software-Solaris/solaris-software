name: ESP-IDF Build
on: [push]

jobs:
  build-solaris-code:
    runs-on: self-hosted

    container:
      image: espressif/idf:v6.0-dev
      options: >-
        --security-opt label=disable

    steps:
      - name: Fix permissions for GitHub workspace
        run: |
          chmod -R 777 "$GITHUB_WORKSPACE" || true
          chmod -R 777 /__w || true

      - name: Checkout repo (no submodules)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false
          persist-credentials: false
          token: ${{ secrets.CI_GH_TOKEN }}
          clean: true

      - name: Mark workspace as safe for Git
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Purge submodule cache (self-hosted runner)
        run: |
          rm -rf solaris-v1/external/esp-idf solaris-v1/external/spp solaris-v1/external/spp-ports || true
          rm -rf .git/modules/solaris-v1/external/esp-idf .git/modules/solaris-v1/external/spp .git/modules/solaris-v1/external/spp-ports || true
          rm -rf .git/modules/solaris-v1/external/spp/third_party/OS/FreeRTOS || true

      - name: Init submodules (only first level)
        run: |
          git submodule sync
          git submodule update --init solaris-v1/external/esp-idf
          git submodule update --init solaris-v1/external/spp
          git submodule update --init solaris-v1/external/spp-ports

      - name: CI workaround: remove broken nested FreeRTOS submodule inside spp
        run: |
          SPP="solaris-v1/external/spp"
          rm -rf "$SPP/third_party/OS/FreeRTOS/.git" || true
          rm -rf ".git/modules/$SPP/third_party/OS/FreeRTOS" || true

          if [ -f "$SPP/.gitmodules" ]; then
            (cd "$SPP" && \
              git config -f .gitmodules --get-regexp '^submodule\..*\.path$' | \
              while read -r key path; do
                if [ "$path" = "third_party/OS/FreeRTOS" ] || [ "$path" = "$SPP/third_party/OS/FreeRTOS" ]; then
                  name="${key#submodule.}"; name="${name%.path}"
                  git config -f .gitmodules --remove-section "submodule.${name}" || true
                fi
              done
            )
          fi

      - name: Ensure git & ssh client
        run: |
          apt-get update
          apt-get install -y git openssh-client
          rm -rf /var/lib/apt/lists/*

      - name: Build firmware
        run: |
          cd solaris-v0.2
          . /opt/esp/idf/export.sh
          idf.py build
