name: ESP-IDF Build
on: [push]

jobs:
  build-solaris-code:
    runs-on: self-hosted

    container:
      image: espressif/idf:v6.0-dev
      options: >-
        --security-opt label=disable

    steps:
      - name: Fix permissions for GitHub workspace
        run: |
          chmod -R 777 "$GITHUB_WORKSPACE" || true
          chmod -R 777 /__w || true

      - name: Wipe workspace
        run: |
          find "$GITHUB_WORKSPACE" -mindepth 1 -maxdepth 1 -exec rm -rf {} +

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false
          persist-credentials: false
          token: ${{ secrets.CI_GH_TOKEN }}
          clean: true

      - name: Mark workspace as safe for Git
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Purge submodule cache
        run: |
          rm -rf .git/modules/* || true
          rm -rf solaris-v1/external/esp-idf solaris-v1/external/spp solaris-v1/external/spp-ports || true

      - name: Force HTTPS for submodules and authenticate
        run: |
          if [ -f .gitmodules ]; then
            sed -i \
              -e 's#git@github.com:#https://github.com/#g' \
              -e 's#ssh://git@github.com/#https://github.com/#g' \
              .gitmodules
          fi
          git config --global url."https://x-access-token:${{ secrets.CI_GH_TOKEN }}@github.com/".insteadOf "https://github.com/"
          git config --global url."https://x-access-token:${{ secrets.CI_GH_TOKEN }}@github.com/".insteadOf "git@github.com:"
          git config --global url."https://x-access-token:${{ secrets.CI_GH_TOKEN }}@github.com/".insteadOf "ssh://git@github.com/"
          git submodule sync --recursive

      - name: Initialize submodules
        run: |
          git submodule update --init solaris-v1/external/esp-idf
          git submodule update --init solaris-v1/external/spp
          git submodule update --init solaris-v1/external/spp-ports

      - name: Build firmware
        run: |
          cd solaris-v0.2
          . /opt/esp/idf/export.sh
          idf.py build
